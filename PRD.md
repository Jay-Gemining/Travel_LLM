# 产品需求文档 (PRD): 行程AIGC (Travel_LLM)

**版本**: 2.0
**日期**: 2025年7月4日
**负责人**: Gemini

---

## 0. 修订历史

- **V2.2 (2025/07/07)**: **天气应变计划**。为户外活动提供一键获取室内备选方案的功能，并**接入OpenWeatherMap API获取实时天气数据**。
- **v2.1 (2025/07/07)**: **手动添加活动**。允许用户通过弹窗表单向指定日期手动添加新的活动。
- **v2.0 (2025/07/04)**: **实现中期规划**。引入拖拽排序、交互式地图视图。
- **v1.3 (2025/07/04)**: **引入动态编辑**。实现活动删除、时间修改功能，并由AI自动重算交通时间。
- **v1.2 (2025/07/01)**: **产品升维**。深度整合美食规划，引入预算控制、开放时间与预订链接等“可执行”信息，增加行程保存与分享功能。
- **v1.1 (2025/07/01)**: 增强输入（必游景点、旅行风格），提升输出质量（地理坐标、交通时间），并增加活动替换功能。
- **v1.0 (2025/06/30)**: 初始版本，定义核心生成流程。

---

## 1. 产品简介与愿景

### 1.1. 产品简介

行程AIGC (Travel_LLM) 是一个基于大型语言模型（LLM）的智能旅行规划应用。它允许用户通过输入全面的旅行偏好，快速生成一份内容详尽、可执行的个性化旅行日程，并支持对生成的日程进行动态调整。

### 1.2. 产品愿景

我们的愿景是将 Travel_LLM 打造成一个**动态、贴心、可执行的私人旅行管家**。它不仅能生成行程，更能理解用户的深层需求（如预算、口味），预见并解决用户在旅行中可能遇到的实际问题（如开放时间、预订），并能灵活适应用户的即时调整，创造顺畅、愉悦、无忧的旅行规划体验。

---

## 2. 目标用户

* **主要用户** : 计划进行1-7天短途旅行的个人或小团体游客。
* **用户特征** :
  * 追求效率，希望快速获得行程参考的年轻用户。
  * 对AI新应用感兴趣，愿意尝试使用智能工具的科技爱好者。
  * 对目的地不熟悉，需要规划指导的初次访问者。

---

## 3. 核心功能与用户故事

### 3.1. 功能列表

- **F1**: 用户输入全面的旅行偏好（城市、天数、兴趣、旅行风格、必游景点、预算、餐饮偏好）。
- **F2**: AI智能生成包含活动与美食的混合行程。
- **F3**: 结构化展示每日行程计划，并附带开放时间、预订链接、当地人贴士等丰富信息。
- **F4**: 加载与错误状态处理。
- **F5**: 用户可对单个活动进行“替换”操作。
- **F6**: 用户可以保存生成的行程，并在需要时分享给他人。
- **F7**: 用户可以**动态编辑**行程，包括**删除**任意活动、**修改**活动时间。
- **F8**: 在用户编辑行程后，AI会**自动重新计算并更新**活动间的交通时间。
- **F9 (新增)**: 用户可在日程中随意**拖拽活动**，调整顺序或移动到不同日期。
- **F10 (新增)**: **交互式地图视图**，将每日行程的所有点在地图上进行可视化展示。
- **F11 (新增)**: 用户可以**手动添加**新的活动到某一天。
- **F12 (新增)**: 用户可以为室外活动一键获取**天气备选方案**。

### 3.2. 用户故事

- **作为一名美食爱好者**: 我希望AI不仅能推荐餐厅，还能根据我的预算和口味，将合适的餐厅穿插在我的日程中。
- **作为一名注重效率的规划者**: 我希望生成的行程直接告诉我景点的开放时间和餐厅的预订电话/链接。
- **作为一名行程多变的用户**: 我希望可以随时删除某个不想去的景点了，并且行程的交通时间能自动更新，而不需要我从头再来一遍。
- **作为一名用户**: 我精心调整好的行程，希望能保存下来，方便我之后随时查看，或者发给我的朋友一起讨论。
- **作为一名追求效率的用户**: 我希望能够通过拖拽的方式快速调整行程顺序，并且在地图上直观地看到路线变化。
- **作为一名有明确想法的用户**: 我希望在AI生成的基础上，能手动添加一个我想去的、但AI没有推荐的特定地点。
- **作为一名灵活应变的用户**: 我希望当遇到下雨天时，能快速获得当前户外活动的室内替代方案，而不需要重新规划整个行程。

---

## 4. 功能规格 (Functional Specifications)

### 4.1. 前端 (React)

#### 4.1.1. 主页 (`HomePage.jsx`)

- **输入表单**:
  - 总体预算: 下拉选择框（经济、标准、优质）。
  - 餐饮偏好: 人均消费、菜系/口味、忌口/特殊要求。
  - 其他输入项（城市、天数、兴趣等）保持不变。

#### 4.1.2. 结果页 (`ResultsPage.jsx`)

- **顶部操作栏**:
  - “返回重新规划”按钮。
  - “保存行程”按钮。
  - “分享”按钮（点击后复制行程文本到剪贴板）。
- **活动/美食卡片 (`PoiCard.jsx`)**:
  - 删除按钮: 每张卡片提供一个删除按钮，点击后该活动将从行程中移除。
  - 时间编辑: 用户可直接点击活动时间进行修改。
  - “换一个”按钮保持不变。
- **自动更新机制**:
  - 在用户删除活动或修改时间后，前端会（通过防抖机制）调用后端API，并用返回的最新行程数据更新界面，确保交通时间等信息的准确性。
- **(新增) 拖拽排序**: 用户可以通过拖拽方式调整活动顺序。
- **(新增) 交互式地图**: 显示当前日期的活动在地图上的位置和路线。
- **(新增) 手动添加活动**: 
  - 在每日活动列表顶部提供一个“添加新活动”按钮。
  - 点击后，弹出一个模态框（`AddActivityModal.jsx`），包含活动名称、时间、类别的输入字段。
  - 提交后，新活动被添加到当前日期的活动列表中，并触发后端的交通时间重算。
- **(新增) 天气备选方案**: 
  - 在 `PoiCard.jsx` 中，为“景点”类别的活动（特别是户外活动）添加一个“天气备选”按钮。
  - 点击按钮后，调用后端API (`/api/weather-contingency`) 获取一个室内替代方案。
  - 替代方案通过一个临时卡片（`WeatherContingency.jsx`）展示，用户可以选择“接受”或“忽略”。
  - “接受”后，原活动被替换，并触发交通时间重算。

### 4.2. 后端 (FastAPI)

#### 4.2.1. API 端点 (`main.py`)

- **`POST /api/plan`**: 接收用户偏好，生成全新行程。
- **`POST /api/regenerate-activity`**: 接收上下文，为单个活动生成替代选项。
- **`POST /api/save-itinerary`**: 接收完整行程JSON，保存到文件。
- **`POST /api/update-itinerary`**: 接收用户修改后的完整行程JSON数据，调用AI服务重新计算并更新所有活动间的 `<travel_from_previous>` 字段，并返回更新了交通时间的完整行程JSON。
- **`POST /api/weather-contingency`**: 接收一个户外活动信息，**调用高德地图API获取实时天气数据，并将天气数据和活动信息一并传递给AI服务**，生成一个室内替代方案，并返回新的活动JSON。

#### 4.2.2. AI服务逻辑 (`services.py`)

- **提示词工程 (`prompt_template.py`)**:
  - `PROMPT_TEMPLATE`: 用于生成完整行程。
  - `REGENERATE_PROMPT_TEMPLATE`: 用于替换单个活动。
  - `RECALCULATE_TRAVEL_PROMPT_TEMPLATE`: 指令AI只更新行程中的交通时间，并保持其他所有信息不变。
  - `WEATHER_CONTINGENCY_PROMPT_TEMPLATE`: 指令AI为户外活动生成室内备选方案。
- **核心服务**:
  - `generate_plan_from_llm`: 生成完整行程。
  - `regenerate_activity_from_llm`: 替换活动。
  - `recalculate_itinerary_travel_times`: 接收修改后的行程，调用AI更新交通时间。
  - `generate_weather_contingency_plan`: 接收户外活动信息，**以及实时天气数据**，调用AI生成室内备选方案。

#### 4.2.3. 数据模型 (`schemas.py`)

- **`(更新) ItineraryItem`**: 新增 `id` 字段，用于前端拖拽排序的唯一标识。
- 其他模型 (`PlanRequest` 等) 保持一致。

---

## 5. 用户流程 (User Flow)

*(流程更新以反映新功能)*

1. **填写信息**: 用户输入“杭州”，选择“2天”，兴趣“丝绸文化”，预算“标准”，餐饮偏好为“本地特色、人均¥150以内”。
2. **查看结果**: AI生成了包含景点和餐厅的详细行程，并在右侧地图上展示了当天的路线。
3. **动态调整**: 用户觉得第二天的某个景点不太感兴趣，点击了该活动卡片上的“删除”按钮。卡片消失，片刻后，后续活动的“交通时间”自动更新了，地图上的路线也随之调整。
4. **拖拽调整**: 用户发现某个活动的时间安排不合理，直接拖拽该活动卡片到同一天的另一个位置。活动顺序更新，交通时间自动重算，地图路线也实时更新。
5. **手动添加**: 用户想起一个朋友推荐的咖啡馆，点击“添加新活动”按钮，输入名称、时间和类别后，这个咖啡馆就被加到了行程末尾，并自动更新了交通信息。
6. **天气应变**: 突然下雨，用户点击某个户外景点卡片上的“天气备选”按钮，系统弹出一个室内咖啡馆的建议。用户点击“接受”，该咖啡馆替换了原景点，交通时间也随之更新。
7. **保存与分享**: 用户对调整后的行程很满意，点击“保存行程”，系统提示“保存成功！”。随后用户点击“分享”，复制了一个链接发给朋友。

---

## 6. 未来规划 (Roadmap)

- **V2.0 (当前已实现)**:
  - 深度美食规划、预算控制及“可执行信息”增强。
  - 行程的保存与分享。
  - 基础的动态编辑：支持删除活动、修改时间，并自动重算交通耗时。
  - **高级编辑功能**：拖拽调整活动顺序。
  - **交互式地图视图**：在地图上可视化行程路线。
  - **手动添加**: 支持通过搜索或表单手动添加新的兴趣点到行程中。
- **V2.1 (中期)**:
  - **天气应变计划**: 接入高德地图API，为恶劣天气提供室内备选方案。
- **V2.2 (长期)**:
  - **智能住宿推荐**: 根据预算和行程地点，推荐酒店或民宿。
  - **精细化交通规划**: 提供具体的市内交通方式（公交、地铁线路）。
  - **多语言支持**。
